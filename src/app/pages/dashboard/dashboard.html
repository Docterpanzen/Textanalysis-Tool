<div>
  <!-- Header -->
  <header class="flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-semibold">Dashboard</h1>
      <p class="mt-1 text-sm text-slate-400">Überblick über deine letzten Plagiatsprüfungen.</p>
    </div>

    <button
      (click)="goToInput()"
      class="px-4 py-2 transition delay-100 hover:scale-110 rounded-xl bg-sky-600 hover:bg-sky-500 text-sm font-medium cursor-pointer"
    >
      Neue Texte hinzufügen
    </button>
  </header>

  <!-- Analyse-Historie -->
  <section class="my-6 rounded-2xl border border-slate-800 bg-slate-900/40 p-4 space-y-4">
    <div class="flex flex-wrap items-start justify-between gap-4">
      <div>
        <h2 class="text-sm font-medium text-slate-200">Analyse-Historie</h2>
        <p class="mt-1 text-xs text-slate-500">Letzte Analysen, Details per Klick.</p>
      </div>
    </div>

    <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
      <div class="rounded-md border border-slate-800 bg-slate-950/60 p-3">
        <p class="text-xs text-slate-500">Jobs insgesamt</p>
        <p class="mt-1 text-2xl font-semibold text-slate-100">
          {{ historyOverview?.totalRuns ?? 0 }}
        </p>
      </div>
      <div class="rounded-md border border-slate-800 bg-slate-950/60 p-3">
        <p class="text-xs text-slate-500">Heute</p>
        <p class="mt-1 text-2xl font-semibold text-slate-100">
          {{ historyOverview?.todayRuns ?? 0 }}
        </p>
      </div>
      <div class="rounded-md border border-slate-800 bg-slate-950/60 p-3">
        <p class="text-xs text-slate-500">Letzter Job</p>
        <p class="mt-1 text-sm font-semibold text-slate-100">
          {{ latestRunLabel }}
        </p>
      </div>
      <div class="rounded-md border border-slate-800 bg-slate-950/60 p-3">
        <p class="text-xs text-slate-500">Ø Texte pro Run</p>
        <p class="mt-1 text-2xl font-semibold text-slate-100">
          {{ averageTextsPerRun }}
        </p>
      </div>
    </div>

    @if (historyError) {
      <p class="text-xs text-rose-400">{{ historyError }}</p>
    }

    <div class="grid gap-4 lg:grid-cols-[360px_minmax(0,1fr)]">
      <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-3">
        <div class="flex items-center justify-between">
          <span class="text-xs text-slate-400">Letzte Analysen</span>
          <span class="text-xs text-slate-500">
            Gefiltert: {{ historyOverview?.filteredRuns ?? historyRuns.length }}
          </span>
        </div>

        <div class="mt-3 flex flex-wrap items-end gap-2 text-xs text-slate-400">
          <label class="flex flex-col gap-1">
            <span>Sortierung</span>
            <button
              type="button"
              class="h-[30px] w-[40px] rounded-lg border border-slate-700 bg-slate-900 text-slate-100 cursor-pointer"
              (click)="toggleSortOrder()"
              aria-label="Sortierung umschalten"
            >
              @if (sortOrder === 'asc') {
                <img
                  src="assets/Input/arrow_up_white_icon.svg"
                  alt=""
                  class="mx-auto h-4 w-4"
                />
              } @else {
                <img
                  src="assets/Input/arrow_down_white_icon.svg"
                  alt=""
                  class="mx-auto h-4 w-4"
                />
              }
            </button>
          </label>
          <label class="flex flex-col gap-1">
            <span>Text-IDs</span>
            <input
              type="text"
              placeholder="z. B. 12, 18, 21"
              class="rounded-lg border border-slate-700 bg-slate-900 px-2 py-1 text-xs text-slate-100"
              [(ngModel)]="textIdFilter"
            />
          </label>
          <button
            (click)="updateHistoryView()"
            class="h-[30px] px-3 rounded-lg bg-sky-600 hover:bg-sky-500 text-xs font-medium cursor-pointer"
          >
            Anwenden
          </button>
        </div>

        @if (historyLoading) {
          <p class="mt-3 text-xs text-slate-500">Lade Historie...</p>
        } @else if (historyRuns.length === 0) {
          <p class="mt-3 text-xs text-slate-500">Keine Läufe gefunden.</p>
        } @else {
          <ul class="mt-3 space-y-2">
            @for (run of historyRuns; track run.id) {
              <li
                class="rounded-md border border-slate-800 bg-slate-900/70 p-3 cursor-pointer transition hover:border-slate-600"
                [class.border-sky-500]="selectedRunId === run.id"
                (click)="selectRun(run)"
              >
                <p class="text-xs text-slate-100">{{ formatTimestamp(run.created_at) }}</p>
                <div class="mt-1 flex items-center justify-between text-[11px] text-slate-400">
                  <span>{{ run.vectorizer }} · k={{ run.numClusters }}</span>
                  <span>{{ run.textCount }} Texte</span>
                </div>
                <p class="text-[11px] text-slate-500">{{ run.clusterCount }} Cluster</p>
              </li>
            }
          </ul>
        }
      </div>

      <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-3">
        @if (detailLoading) {
          <p class="text-xs text-slate-500">Lade Details...</p>
        } @else if (!selectedRun) {
          <p class="text-xs text-slate-500">Wähle links einen Job aus.</p>
        } @else {
          <div class="flex flex-wrap items-start justify-between gap-3">
            <div>
              <h3 class="text-sm font-medium text-slate-100">
                Analyse vom {{ formatTimestamp(selectedRun.created_at) }}
              </h3>
              <p class="text-xs text-slate-500">
                Vectorizer: {{ selectedRun.options.vectorizer }} · k={{
                  selectedRun.options.numClusters
                }}
              </p>
            </div>
            <div class="text-xs text-slate-500">
              Texte: {{ selectedRun.texts.length }} · Cluster: {{ selectedRun.clusters.length }}
            </div>
          </div>

          <div class="mt-3 grid gap-3 md:grid-cols-2">
            <div class="rounded-lg border border-slate-800 bg-slate-900/70 p-3">
              <h4 class="text-xs font-medium text-slate-200">Einstellungen</h4>
              <div class="mt-2 space-y-1 text-xs text-slate-400">
                <div class="flex items-center justify-between">
                  <span>Vectorizer</span>
                  <span class="text-slate-200">{{ selectedRun.options.vectorizer }}</span>
                </div>
                <div class="flex items-center justify-between">
                  <span>Max Features</span>
                  <span class="text-slate-200">{{ formatOption(selectedRun.options.maxFeatures) }}</span>
                </div>
                <div class="flex items-center justify-between">
                  <span>Dim. Reduktion</span>
                  <span class="text-slate-200">{{ formatOption(selectedRun.options.useDimReduction) }}</span>
                </div>
                <div class="flex items-center justify-between">
                  <span>Komponenten</span>
                  <span class="text-slate-200">{{ formatOption(selectedRun.options.numComponents) }}</span>
                </div>
                <div class="flex items-center justify-between">
                  <span>Stopwords</span>
                  <span class="text-slate-200">{{ formatOption(selectedRun.options.useStopwords) }}</span>
                </div>
                <div class="flex items-center justify-between">
                  <span>Stopword-Modus</span>
                  <span class="text-slate-200">{{ formatOption(selectedRun.options.stopwordMode) }}</span>
                </div>
              </div>
            </div>

            <div class="rounded-lg border border-slate-800 bg-slate-900/70 p-3">
              <h4 class="text-xs font-medium text-slate-200">Zusammenfassung</h4>
              <div class="mt-2 space-y-1 text-xs text-slate-400">
                <div class="flex items-center justify-between">
                  <span>Texte</span>
                  <span class="text-slate-200">{{ selectedRun.texts.length }}</span>
                </div>
                <div class="flex items-center justify-between">
                  <span>Cluster</span>
                  <span class="text-slate-200">{{ selectedRun.clusters.length }}</span>
                </div>
              </div>
            </div>

            <div class="rounded-lg border border-slate-800 bg-slate-900/70 p-3 md:col-span-2">
              <div class="flex items-center justify-between">
                <h4 class="text-xs font-medium text-slate-200">Cluster-Ausgabe</h4>
                <span class="text-[11px] text-slate-500">
                  {{ selectedRun.clusters.length }}
                </span>
              </div>

              @if (selectedRun.clusters.length === 0) {
                <p class="mt-2 text-xs text-slate-500">Keine Cluster gespeichert.</p>
              } @else {
                <div class="mt-2 grid gap-2 md:grid-cols-2">
                  @for (cluster of selectedRun.clusters; track cluster.id) {
                    <div class="rounded-lg border border-slate-800 bg-slate-950/60 p-2">
                      <div class="flex items-center justify-between text-xs text-slate-200">
                        <span>Cluster {{ cluster.clusterIndex + 1 }}</span>
                        <span>{{ cluster.size }} Texte</span>
                      </div>
                      <p class="mt-1 text-[11px] text-slate-400">
                        Top Terms: {{ cluster.topTerms.join(', ') }}
                      </p>
                      <p class="text-[11px] text-slate-500">
                        Texte: {{ cluster.textNames.join(', ') }}
                      </p>
                      @if (cluster.wordCloudPng) {
                        <img
                          class="mt-2 w-full rounded-md border border-slate-800 bg-slate-900/50"
                          [src]="'data:image/png;base64,' + cluster.wordCloudPng"
                          alt="Wordcloud Cluster {{ cluster.clusterIndex + 1 }}"
                          (click)="openWordcloud(cluster.wordCloudPng); $event.stopPropagation()"
                        />
                      }
                    </div>
                  }
                </div>
              }
            </div>

            <div class="rounded-lg border border-slate-800 bg-slate-900/70 p-3 md:col-span-2">
              <div class="flex items-center justify-between">
                <h4 class="text-xs font-medium text-slate-200">Texte</h4>
                <span class="text-[11px] text-slate-500">{{ selectedRun.texts.length }}</span>
              </div>

              @if (selectedRun.texts.length === 0) {
                <p class="mt-2 text-xs text-slate-500">Keine Texte gespeichert.</p>
              } @else {
                <ul class="mt-2 divide-y divide-slate-800">
                  @for (text of selectedRun.texts; track text.id) {
                    <li class="py-2">
                      <div
                        class="flex items-center justify-between cursor-pointer"
                        (click)="toggleHistoryText(text.id)"
                      >
                        <div class="min-w-0">
                          <p class="truncate text-xs text-slate-100">{{ text.name }}</p>
                          <p class="text-[11px] text-slate-500">
                            {{ formatTimestamp(text.created_at) }}
                          </p>
                        </div>
                        <span class="text-[11px] text-slate-500">
                          {{ text.content.length }} Zeichen
                        </span>
                      </div>

                      @if (openHistoryText?.id === text.id) {
                        <pre
                          class="mt-2 rounded-lg border border-slate-800 bg-slate-950/60 p-2 text-xs text-slate-100 whitespace-pre-wrap max-h-48 overflow-y-auto"
                        >
{{ text.content }}
                        </pre>
                      }
                    </li>
                  }
                </ul>
              }
            </div>
          </div>
        }
      </div>
    </div>

    @if (activeWordcloud) {
      <div
        class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/80 p-4"
        (click)="closeWordcloud()"
      >
        <div
          class="w-full max-w-5xl rounded-xl border border-slate-800 bg-slate-950 p-4"
          (click)="$event.stopPropagation()"
        >
          <div class="flex items-center justify-between">
            <p class="text-sm font-medium text-slate-200">Wordcloud</p>
            <button
              class="px-3 py-1 rounded-lg border border-slate-700 text-xs text-slate-200 hover:border-slate-500 transition"
              (click)="closeWordcloud()"
            >
              Schließen
            </button>
          </div>
          <img
            class="mt-3 w-full rounded-lg border border-slate-800 bg-slate-900/50"
            [src]="'data:image/png;base64,' + activeWordcloud"
            alt="Wordcloud Detail"
          />
        </div>
      </div>
    }
  </section>
</div>

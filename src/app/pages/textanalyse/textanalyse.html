<div>
  <!-- Header -->
  <header class="flex items-center justify-between mb-4">
    <div>
      <h1 class="text-3xl font-semibold">Textanalyse</h1>
      <p class="mt-1 text-sm text-slate-400">
        Nutze die gespeicherten Texte aus der Datenbank und konfiguriere die Analyse-Pipeline.
      </p>
    </div>

    <div class="flex gap-2">
      <button
        (click)="goToInput()"
        class="px-4 py-2 rounded-xl bg-sky-600 hover:bg-sky-500 text-sm font-medium cursor-pointer transition delay-100 hover:scale-110"
      >
        Neue Texte hinzufügen
      </button>
    </div>
  </header>

  <!-- Global loading info -->
  @if (isLoading) {
    <div
      class="mb-4 inline-flex items-center gap-2 rounded-xl bg-sky-900/40 border border-sky-700/60 px-3 py-2 text-xs text-sky-100"
    >
      <span
        class="inline-block w-4 h-4 border-2 border-sky-300 border-t-transparent rounded-full animate-spin"
      ></span>
      <span>Analyse läuft … je nach Textmenge kann dies einige Sekunden dauern.</span>
    </div>
  }

  <!-- Auswahl der Texte (Summary) -->
  <section
    class="my-4 rounded-2xl border border-slate-800 bg-slate-900/60 p-4 flex items-center justify-between"
  >
    <div>
      <h2 class="text-sm font-medium text-slate-200">Auswahl der Texte</h2>
      @if (hasDbTexts) {
        <p class="mt-1 text-xs text-slate-500">
          {{ dbTexts.length }} Text(e) in der Datenbank, {{ selectedCount }} ausgewählt.
        </p>
      } @else {
        <p class="mt-1 text-xs text-slate-500">
          Noch keine Texte in der Datenbank. Lade im Tab
          <span class="font-mono text-[11px]">Input</span>
          neue Texte hoch und speichere sie.
        </p>
      }
    </div>

    <button
      type="button"
      (click)="showSelectionPanel = true"
      class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-xs font-medium cursor-pointer transition delay-100 hover:scale-110 border border-slate-600"
    >
      Texte auswählen
    </button>
  </section>

  <!-- SELECTION DRAWER (unverändert: nur Auswahl + Preview) -->
  @if (showSelectionPanel) {
    <div class="fixed inset-0 z-40 flex justify-end bg-slate-950/70">
      <div class="flex-1" (click)="showSelectionPanel = false"></div>

      <div
        class="h-full bg-slate-900 border-l border-slate-800 shadow-xl flex flex-col relative"
        [ngStyle]="{ width: selectionPanelWidth + 'px' }"
      >
        <!-- Resize handle -->
        <div class="resize-handle" (mousedown)="startResizing($event)"></div>

        <!-- Drawer header -->
        <div class="px-4 py-3 border-b border-slate-800 flex items-center justify-between">
          <div>
            <h2 class="text-sm font-medium text-slate-100">Texte auswählen</h2>
            <p class="text-xs text-slate-500">Wähle hier die Texte für die Analyse aus.</p>
          </div>

          <button
            type="button"
            (click)="showSelectionPanel = false"
            class="text-slate-400 hover:text-slate-100 rounded-lg p-1 transition"
          >
            ✕
          </button>
        </div>

        <!-- Drawer content -->
        <div class="flex-1 overflow-y-auto px-4 py-3">
          @if (!hasDbTexts) {
            <p class="text-xs text-slate-500">
              Noch keine Texte in der Datenbank. Lade im Tab
              <span class="font-mono text-[11px]">Input</span>
              neue Texte hoch und speichere sie.
            </p>
          } @else {
            <ul class="divide-y divide-slate-800">
              @for (txt of dbTexts; track txt.id) {
                <li class="py-2">
                  <div class="flex items-start justify-between gap-2">
                    <!-- checkbox + meta -->
                    <label class="flex items-start gap-3 cursor-pointer">
                      <input
                        type="checkbox"
                        [checked]="selectedTextIds.has(txt.id)"
                        (change)="toggleTextSelection(txt.id)"
                        class="mt-1 rounded border-slate-600"
                      />

                      <div class="min-w-0">
                        <p class="truncate text-sm text-slate-100">
                          {{ txt.name }}
                        </p>
                        <p class="text-xs text-slate-500">
                          ID: {{ txt.id }}
                          @if (txt.created_at) {
                            · {{ txt.created_at | date: 'short' }}
                          }
                        </p>
                      </div>
                    </label>

                    <!-- open/close preview -->
                    <button
                      type="button"
                      (click)="toggleOpen(txt.id)"
                      class="text-slate-400 hover:bg-sky-500 rounded-lg p-1 transition delay-100 hover:scale-110"
                    >
                      @if (isOpen(txt.id)) {
                        <img src="assets/Input/arrow_up_white_icon.svg" alt="" class="w-5 h-5" />
                      } @else {
                        <img src="assets/Input/arrow_down_white_icon.svg" alt="" class="w-5 h-5" />
                      }
                    </button>
                  </div>

                  <!-- Collapsible preview -->
                  @if (isOpen(txt.id)) {
                    <div
                      class="mt-2 rounded-lg bg-slate-900 border border-slate-700 p-2 space-y-2 max-h-100 overflow-y-auto"
                    >
                      @if (!txt.content) {
                        <p class="text-xs text-slate-500">
                          Kein Inhalt geladen. Stelle sicher, dass das Backend die Inhalte
                          mitsendet.
                        </p>
                      } @else {
                        <pre class="text-[11px] text-slate-100 whitespace-pre-wrap"
                          >{{ txt.content }}
                        </pre>
                      }
                    </div>
                  }
                </li>
              }
            </ul>
          }
        </div>

        <!-- Drawer footer -->
        <div class="px-4 py-3 border-t border-slate-800 flex items-center justify-between">
          <p class="text-xs text-slate-500">Ausgewählt: {{ selectedCount }}</p>
          <button
            type="button"
            (click)="showSelectionPanel = false"
            class="px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-xs font-medium transition delay-100 hover:scale-110"
          >
            Auswahl übernehmen
          </button>
        </div>
      </div>
    </div>
  }

  <!-- PIPELINE SETTINGS -->
  <section class="my-4 rounded-2xl border border-slate-800 bg-slate-900/40 p-4 space-y-4">
    <h2 class="text-sm font-medium text-slate-200">Pipeline-Einstellungen</h2>

    <div class="grid md:grid-cols-2 gap-4">
      <!-- Vectorizer -->
      <div>
        <label class="block text-xs text-slate-400 mb-1">Vektorrepräsentation</label>
        <select
          [(ngModel)]="vectorizer"
          class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm text-slate-100"
        >
          <option value="bow">Bag-of-Words (BoW)</option>
          <option value="tf">Term Frequency (TF)</option>
          <option value="tfidf">TF-IDF</option>
        </select>
      </div>

      <!-- Max features -->
      <div>
        <label class="block text-xs text-slate-400 mb-1">Maximale Vokabulargröße</label>
        <input
          type="number"
          min="0"
          [(ngModel)]="maxFeatures"
          class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm text-slate-100"
        />
        <p class="mt-1 text-[11px] text-slate-500">
          Max. Anzahl Wörter im Vokabular (0 oder leer = unbegrenzt).
        </p>
      </div>

      <!-- Number of clusters -->
      <div>
        <label class="block text-xs text-slate-400 mb-1">Anzahl Cluster (k)</label>
        <input
          type="number"
          min="2"
          [(ngModel)]="numClusters"
          class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm text-slate-100"
        />
      </div>

      <!-- Dimensionality reduction -->
      <div>
        <label class="flex items-center gap-2 text-xs text-slate-400 mb-1">
          <input type="checkbox" [(ngModel)]="useDimReduction" class="rounded" />
          Dimensionsreduktion (z.B. SVD) verwenden
        </label>

        @if (useDimReduction) {
          <input
            type="number"
            min="2"
            [(ngModel)]="numComponents"
            class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm text-slate-100"
          />
        }
      </div>

      <!-- Stopword settings -->
      <div>
        <label class="flex items-center gap-2 text-xs text-slate-400 mb-1">
          <input type="checkbox" [(ngModel)]="useStopwords" class="rounded" />
          Stoppwörter entfernen
        </label>

        @if (useStopwords) {
          <select
            [(ngModel)]="stopwordMode"
            class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm text-slate-100"
          >
            <option value="de">Deutsch</option>
            <option value="en">Englisch</option>
            <option value="de_en">Deutsch + Englisch</option>
            <option value="none">Keine Stoppwörter</option>
          </select>
          <p class="mt-1 text-[11px] text-slate-500">
            Entfernt häufige Funktionswörter (z.B. „und“, „der“, „the“, „and“).
          </p>
        } @else {
          <p class="mt-1 text-[11px] text-slate-500">
            Stoppwörter werden nicht entfernt – alle Wörter bleiben im Vokabular.
          </p>
        }
      </div>
    </div>

    <div class="mt-4 flex justify-end">
      <button
        type="button"
        (click)="startAnalysis()"
        [disabled]="selectedCount === 0 || isLoading"
        class="px-4 py-2 rounded-xl text-sm font-medium bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-800 disabled:text-slate-400 disabled:cursor-not-allowed cursor-pointer transition delay-100 hover:scale-110"
      >
        @if (!isLoading) {
          Analyse starten
        } @else {
          <span class="inline-flex items-center gap-2">
            <span
              class="inline-block w-4 h-4 border-2 border-slate-200 border-t-transparent rounded-full animate-spin"
            ></span>
            Analysiere …
          </span>
        }
      </button>
    </div>

    @if (lastAnalysisFinishedAt && !isLoading) {
      <p class="mt-2 text-[11px] text-slate-500">
        Letzte Analyse abgeschlossen um {{ lastAnalysisFinishedAt | date: 'shortTime' }}.
      </p>
    }
  </section>

  <!-- Error message -->
  @if (errorMessage) {
    <p
      class="mb-4 text-sm text-rose-400 bg-rose-500/10 border border-rose-500/30 px-3 py-2 rounded-xl"
    >
      {{ errorMessage }}
    </p>
  }

  <!-- ANALYSIS RESULT (mit Wordcloud + Download/Ansehen je Dokument) -->
  @if (result) {
    <section class="my-6 rounded-2xl border border-slate-800 bg-slate-900/40 p-4 space-y-4">
      <h2 class="text-sm font-medium text-slate-200">Cluster-Ergebnis</h2>
      <p class="text-xs text-slate-500">
        Vokabulargröße (über alle ausgewählten Dokumente): {{ result.vocabularySize }} Wörter
      </p>

      <div class="grid md:grid-cols-2 gap-4">
        @for (cluster of result.clusters; track cluster.id) {
          <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-3 space-y-2">
            <h3 class="text-sm font-semibold text-slate-100">Cluster {{ cluster.id }}</h3>

            <p class="text-xs text-slate-400">
              Typische Wörter:
              <span class="font-mono text-[11px]">
                @if (cluster.topTerms.length > 0) {
                  {{ cluster.topTerms.join(', ') }}
                } @else {
                  (keine aussagekräftigen Wörter)
                }
              </span>
            </p>

            @if (cluster.wordCloudPng) {
              <div class="mt-1 rounded-lg bg-slate-900/80 border border-slate-800 p-2">
                <img
                  [src]="'data:image/png;base64,' + cluster.wordCloudPng"
                  alt="Wordcloud für Cluster {{ cluster.id }}"
                  class="w-full h-auto rounded-md"
                />
              </div>
            }

            <p class="text-xs text-slate-400 mt-2">Dokumente:</p>
            <ul class="space-y-1 text-[11px] text-slate-300">
              @if (cluster.documentNames.length === 0) {
                <li>(keine Dokumente zugeordnet)</li>
              } @else {
                @for (name of cluster.documentNames; track name) {
                  <li class="flex items-center justify-between gap-2">
                    <span class="truncate">{{ name }}</span>
                    <div class="flex gap-1 shrink-0">
                      <button
                        type="button"
                        (click)="openTextFromResult(name, $event)"
                        class="px-1 py-1 rounded-lg bg-slate-800 hover:bg-sky-700 text-[10px] border border-slate-600 cursor-pointer transition delay-100 hover:scale-110"
                      >
                        <img src="assets/Textanalyse/lens_white_icon.svg" class="w-4 h-4" alt="" />
                      </button>
                      <button
                        type="button"
                        (click)="downloadTextFromResult(name, $event)"
                        class="px-1 py-1 rounded-lg bg-slate-800 hover:bg-sky-700 text-[10px] border border-slate-600 cursor-pointer transition delay-100 hover:scale-110"
                      >
                        <img
                          src="assets/Textanalyse/download_white_icon.svg"
                          class="w-4 h-4"
                          alt=""
                        />
                      </button>
                    </div>
                  </li>
                }
              }
            </ul>
          </div>
        }
      </div>
    </section>
  }
</div>
